<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student - Mock Tests</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family:'Segoe UI',sans-serif; background:#f0f2f5; margin:0; }
.navbar { background:#1f3c88; color:#fff; }
.navbar a { color:#fff; text-decoration:none; margin-right:15px; }
.container { margin-top:30px; }
.card { margin-bottom:20px; }
.timer { font-weight:bold; color:red; float:right; }
.search-bar { margin-bottom:20px; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg p-3">
  <a href="#" class="navbar-brand"><i class="fas fa-graduation-cap"></i> Mock Tests</a>
  <a href="student_dashboard.html">Dashboard</a>
  <a href="student_results.html">Results</a>
  <a href="#" onclick="logout()">Logout</a>
</nav>

<div class="container">
  <h3>Available Tests</h3>
  <input type="text" id="searchStudent" class="form-control search-bar" placeholder="Search your classmates (optional)">
  <div id="testsContainer"></div>
</div>

<script>
// Mock student login
const currentStudentId = 1;

// Load localStorage
let students = JSON.parse(localStorage.getItem('students')) || [];
let courses = JSON.parse(localStorage.getItem('courses')) || [];
let tests = JSON.parse(localStorage.getItem('tests')) || [];
let results = JSON.parse(localStorage.getItem('results')) || [];
let studentCourses = JSON.parse(localStorage.getItem('studentCourses')) || {};

// Ensure current student has an array
if(!studentCourses[currentStudentId]) studentCourses[currentStudentId] = [];

// Anti-cheat: detect tab switch & disable copy/paste
let testFormSubmitted = false;
window.addEventListener("blur", () => {
  if(!testFormSubmitted){
    alert("You switched tabs! Your test will be auto-submitted.");
    submitTest();
  }
});
document.addEventListener('copy', e => { e.preventDefault(); alert("Copying is disabled!"); });
document.addEventListener('paste', e => { e.preventDefault(); alert("Pasting is disabled!"); });

// Submit helper function for auto-submit
function submitTest(){
  const form = document.getElementById('testForm');
  if(form){
    testFormSubmitted = true;
    form.requestSubmit();
  }
}

// Render tests filtered by student's selected courses
function renderTests(filter='') {
  const container = document.getElementById('testsContainer');
  container.innerHTML = '';

  const selectedCourses = studentCourses[currentStudentId] || [];
  const availableTests = tests.filter(t => selectedCourses.includes(t.courseId));

  let filteredTests = availableTests;

  if(filter){
    const searchLower = filter.toLowerCase();
    filteredTests = availableTests.filter(t => t.name.toLowerCase().includes(searchLower));
  }

  if(filteredTests.length === 0) container.innerHTML = "<p>No tests available.</p>";

  filteredTests.forEach(test => {
    const card = document.createElement('div');
    card.classList.add('card', 'p-3');
    const courseName = courses.find(c => c.id == test.courseId)?.name || '';

    const prevResult = results.find(r => r.studentId === currentStudentId && r.testId === test.id);
    const buttonText = prevResult ? "Already Submitted" : "Take Test";
    const buttonClass = prevResult ? "btn-secondary" : "btn-primary";

    card.innerHTML = `
      <h5>${test.name} (${courseName}) - ${test.duration} mins</h5>
      <button class="btn ${buttonClass} mt-2" ${prevResult ? "disabled" : `onclick="takeTest(${test.id})"`}>${buttonText}</button>
    `;
    container.appendChild(card);
  });
}

// Search bar filter
document.getElementById('searchStudent').addEventListener('input', function(){
  renderTests(this.value);
});

// Take test (prevents multiple submissions, timer, AI grading, anti-cheat)
function takeTest(testId) {
  const test = tests.find(t => t.id === testId);
  if(!test) return;

  const prevResult = results.find(r => r.studentId === currentStudentId && r.testId === testId);
  if(prevResult){
    alert("You have already submitted this test!");
    return;
  }

  const courseName = courses.find(c => c.id == test.courseId)?.name || '';
  let html = `<h4>${test.name} (${courseName}) <span class="timer" id="timer"></span></h4>`;
  html += `<form id="testForm">`;

  test.questions.forEach((q, idx) => {
    html += `<div class="mb-3"><strong>Q${idx+1}: ${q.question}</strong><br>`;
    if(q.type === 'mcq'){
      q.options.forEach(opt => {
        html += `<div><input type="radio" name="q${idx}" value="${opt}" required> ${opt}</div>`;
      });
    } else if(q.type === 'short'){
      html += `<input type="text" class="form-control" name="q${idx}" required>`;
    }
    html += `</div>`;
  });

  html += `<button type="submit" class="btn btn-success">Submit Test</button></form>`;
  document.getElementById('testsContainer').innerHTML = html;

  // Timer
  let timeLeft = test.duration * 60;
  const timerElem = document.getElementById('timer');
  const timerInterval = setInterval(()=>{
    let mins = Math.floor(timeLeft/60);
    let secs = timeLeft % 60;
    timerElem.textContent = `Time Left: ${mins}m ${secs}s`;
    timeLeft--;
    if(timeLeft < 0 && !testFormSubmitted){
      alert("Time is up! Auto-submitting...");
      submitTest();
    }
  },1000);

  document.getElementById('testForm').addEventListener('submit', function(e){
    e.preventDefault();
    if(testFormSubmitted) return;
    testFormSubmitted = true;
    clearInterval(timerInterval);

    let score = 0;
    test.questions.forEach((q, idx) => {
      const answer = this['q'+idx].value.trim();
      if(q.type === 'mcq' && answer === q.correctAnswer) score++;
      else if(q.type === 'short'){
        const correct = q.correctAnswer.toLowerCase();
        const studentAns = answer.toLowerCase();
        const similarity = getSimilarity(correct, studentAns);
        score += similarity;
      }
    });

    const resultId = Date.now();
    results.push({
      id: resultId,
      studentId: currentStudentId,
      courseId: test.courseId,
      testId: test.id,
      score: score,
      published: false
    });
    localStorage.setItem('results', JSON.stringify(results));
    alert("Test submitted! Your result will be visible once admin publishes it.");
    renderTests();
  });
}

// Simple AI grading for short-answer
function getSimilarity(correct, answer){
  if(answer === correct) return 1;
  let correctWords = correct.split(' ');
  let ansWords = answer.split(' ');
  let matchCount = correctWords.filter(w=> ansWords.includes(w)).length;
  return Math.min(1, matchCount / correctWords.length);
}

// Logout
function logout(){
  alert('Logged out!');
  window.location.href="student_login.html";
}

// Initial render
renderTests();
</script>
</body>
</html>
